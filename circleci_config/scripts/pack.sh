#!/bin/bash
set -e

echoAutoGeneratedComments()
{
  echo "# ---------------------------------------------------"
  echo "# ----- config.yml ----------------------------------"
  echo "# ----- GENERATED CODE - DO NOT MODIFY BY HAND ------"
  echo "# ---------------------------------------------------"
  echo ""
}

# CircleCI CLI must be installed
if ! command -v circleci &> /dev/null
then
    echo "circleci command could not be found"
    exit 1
fi

echo "Changing directory to circleci_config..."
cd circleci_config || exit 1

# Validate the generated configuration prior to replacing the current one
echo "Validating generated config.yml files..."
circleci config pack config-setup | circleci config validate -
circleci config pack config-continuation | circleci config validate -

# Pack the setup config
echo ""
echo "Replacing current .circleci/config.yml file..."
{
  echoAutoGeneratedComments
  circleci config pack config-setup
} > ../.circleci/config.yml

# Pack the continuation config
echo ""
echo "Replacing current .circleci/continue-config.yml file..."
{
  echoAutoGeneratedComments
  circleci config pack config-continuation
} > ../.circleci/continue-config.yml

cd ..

echo "Done!"
